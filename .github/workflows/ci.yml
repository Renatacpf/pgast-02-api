name: CI - PGATS-02-API
permissions:
  checks: write
  pull-requests: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Instalar dependências
        run: npm install

      # Configurar variáveis de ambiente necessárias
      - name: Configurar variáveis de ambiente
        run: |
          echo "JWT_SECRET=supersecret" >> $GITHUB_ENV
          # adicione aqui outras variáveis, como DB_HOST, DB_USER, etc

      # Testes de Controller
      - name: Rodar testes do Controller
        run: npm run test-rest-controller -- --reporter mocha-junit-reporter --reporter-options mochaFile=results-controller.xml

      - name: Publicar relatório Controller
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Controller Tests
          path: results-controller.xml
          reporter: java-junit
          fail-on-error: false

      # Subir a API em background
      - name: Subir API
        run: npm start &
      
      # Esperar API estar funcionando
      - name: Aguardar API na porta 3000
        run: |
          for i in {1..20}; do
            if nc -z localhost 3000; then
              echo "✅ API está pronta!"
              break
            fi
            echo "⏳ Aguardando API..."
            sleep 2
          done

      # Testes de Integração
      - name: Rodar testes de Integração
        run: npm run test-rest-external -- --reporter mocha-junit-reporter --reporter-options mochaFile=results-external.xml || true

      - name: Debug - Ver relatório de integração
        if: always()
        run: cat results-external.xml || echo "⚠️ Nenhum arquivo de resultados encontrado"

      - name: Publicar relatório Integração
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: External Tests
          path: results-external.xml
          reporter: java-junit
          fail-on-error: false

      # Testes externos GraphQL
      - name: Rodar testes externos GraphQL
        run: npm run test-graphql -- --reporter mocha-junit-reporter --reporter-options mochaFile=results-graphql.xml || true

      - name: Debug - Ver relatório GraphQL
        if: always()
        run: cat results-graphql.xml || echo "⚠️ Nenhum arquivo de resultados encontrado"

      - name: Publicar relatório GraphQL
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: GraphQL Tests
          path: results-graphql.xml
          reporter: java-junit
          fail-on-error: false
